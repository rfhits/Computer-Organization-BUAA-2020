# P7课下学习

这个P7，我连教程都没看懂。  
是我太菜了，，，感觉教程就在讲谜语？/(ㄒoㄒ)/

于是开始看高老师的PPT

## 日程

### 2020.12.20-第一天

Pr的缩写应该是Processer，DEV我自己猜是Device(s)

#### CPU外接设备

CPU外接其他设备时，其他的设备也有自己的DataMemory。  
比如接一个U盘，CPU也会对U盘读写。

分析下具体过程：

写过程：  
CPU要算出要写的外接设备的地址，这个地址得传入到U盘里，  
CPU还得传出要写得数据具体的值，也传入到U盘里。

读过程：  
和写过程基本一样，CPU算出读的地址，不一样的地方在于，U盘这个外设要传出自己被读出的数据。  
同时，不必加上写使能。

#### 外接多设备

CPU有时候不仅要接U盘，还要接光盘（想起张伟天天说“刻光盘”了吗，hh）、接显示器、接...whatever。

每一种设备都要有自己的接口逻辑，就很麻烦，所以引入Bridge，把逻辑写到Bridge里面

其实就是把外接设备看成要读写的存储器，  
知道了这些，Bridge就不难理解了。

#### 什么是异常(Exception)

#### Controller

新增三大指令，，管它是干嘛的，先加上再说。  
直接跳到提交入口看端口定义

还有BD、load、store、RI信号

### 2020.12.21

#### 异常中断返回

这一部分是面对NPC逻辑的修改

面对异常和中断，PC要跳转到相应的代码段。  
所以异常处理结束后，接受eret信号，  
PC走到相应地址；  
中断来临，进入一个叫做Exception Handler的代码段。

#### PC地址异常

这是第一个要处理的异常。  
在Fetch-Stage要解析出这种异常，并且流水下去

#### 流水ExcCode和BD

分别是检测异常和面对异常的两种策略

ExcCode检测各种异常，BD来自D-Stage，  
得到BD后返回性接回IFID，  
但一条指令后面和BD为1同时流水，表示这条指令前面有个Branch/J指令

#### 流水ExcCode

1. Fetch阶段的异常，就是PC地址出问题，  
应对方法是，instr置为nop，ExcCode置为4

2. Decode阶段的异常，就是遇到了未定义的指令。  
注意，RI那一段的逻辑不包括nop。  
要区分正常的nop和Fetch阶段异常而产生的nop，只能通过ExcCode。  
Decode产生异常的必要条件是Fetch阶段不产生异常  
所以更新Decode下的ExcCode不能单纯凭借instr==nop

3. Execute阶段异常，为溢出异常

#### 异常与中断的处理流程

私以为这是最重要的话，可惜放到最后才讲。

Step1-引导与识别：读取Cause和EPC寄存器，判断错误类型。

Step2-构造异常处理环境：保存现场。

Step3-处理异常：根据异常类型和其他属性执行对应处理。

Step4-准备返回：恢复现场。

Step5-从异常返回：eret指令。

针对各类中断和异常，软件对应Step3具体对应的处理是：

若为中断，则视情况对外设进行操作（如修改计时器的设置），EPC不作修改。
若为取数异常/存数异常/算术溢出，则视情况修改EPC为受害指令的下一条。
若为取指异常/RI，则更改EPC的值为受害指令的下一条。
