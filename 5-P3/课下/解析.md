# P3解析

## 写在前面

[BUAA-Wander的说明](https://www.cnblogs.com/BUAA-Wander/p/11790154.html)  
这个学长写得比较全面  
我参考了这篇文章

## 此次测试需要的注意的点

1. 指令需要0扩展还是符号扩展、需不需要左移两位  

2. 控制器需要灵活运用合取和或取，然后造表

3. PC和MemAddr的取址，是取2-6位

剩下的都是细节

## 总体设计概览

设计思想：高内聚、低耦合。  
每一个模块，各司其职。  
这样的结果，就是思路清晰。

使用Logisim开发一个简单的MIPS单周期CPU，总体概述如下：

1. 此CPU为32位CPU

2. 此CPU为单周期设计

3. 此CPU支持的指令集为：  
{addu, subu, ori, lw, sw, beq, lui, nop}

4. nop机器码为0x00000000

5. addu, subu 不支持溢出

6. 以下说明均从功能的角度出发，因为具体的端口声明可以在我的设计文档中找到

## 模块说明

### IFU (Instruction Fetch Unit)

内含PC连接到IM，取出instruction，给整个CPU解析  
还要根据instruction来计算NPC，在时钟来临后，把NPC打入到PC里

### GRF (General Register File)

这个和P0一样的啦，但是确实，P0测地很弱，  
我自己测试的时候发现我一根线接错了，但是P0让我过了。  
我劝大家点亮自己的输入端，  
然后把自己每一行的寄存器检查一遍，看看有没有线接错。  
如果懒，，~~可以copy学长的~~，找人对拍。

### ALU (Arithmetic and Logic Unit)

根据CPU需要实现的指令来确定自己的ALU要做哪些操作。  
比如加减运算等，  
通过一个ALUop来“告诉”CPU要对输入的数干什么，然后输出。

比如addu就要CPU做加法，  
lw和sw就要CPU（把扩展的imm32和GRF中取出的数）做加法  
ori就要CPU做或取

### DM (Data Memorary)

这个模块结构也简单，其实甚至不用单开一个模块，  
单开一个模块只是为了整个CPU的美观

### EXT (Extender)

设置ExtOp端口，“告诉”EXT要符号扩展还是无符号扩展

### CTL (Controller)

Controller可谓是整个单周期CPU的重中之重了  
可以说，Controller负责“关节”，（我个人倾向这个叫法）  
以下列出它控制的“关节”

|信号名|方向|描述|
|:---:|:---:|:---:|
|op[5:0]|I||
|func[5:0]|I||
|ALUop[3:0]|O|ALU|
|AluSrc[3:0]|||

---

ALU-part

来的是哪条指令？——op和func决定，引入中间变量  
ALU要执行什么操作？——由中间变量决定

|指令|op|func|
|:---:|:---:|:---:|
|addu|000000|100001|
|subu|000000|100011|
|ori|001101||
|lw|100011||
|sw|101011||
|beq|000100||
|lui|001111||

Q:

1. why begin with IFU?  
IFU取到指令后，指令指挥整个CPU

2. ALU 做啥
同GRF，不关心我要面对lw还是add，我只要做一个ALU应该关心的
加减乘除，或取合取  
至于进行运算的对象是谁，这是controller应该关心的

所以ALUop有多少位，就决定ALU做多少运算  
加减乘除、或取合取，一个比较好的ALU至少要有3位的ALUop输入

How to debug?

1. modular by modular

2. 线路连接  
我把reset接到GRF的clk端口上了。  
所以要检查线路的连接，tunnel是不是对上了端口

3. datapath检查

4. Controller检查

那些关节，什么时候置一，什么时候为0
比如beq，imm16扩展要sign
